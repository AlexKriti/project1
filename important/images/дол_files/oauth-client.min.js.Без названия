!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define("@mail/oauth",["exports"],b):b(a.MR={})}(this,function(a){"use strict";var b=window;function c(){}function d(a,d){!function(a,d){var e,f=function(a){(a||4===e.readyState)&&(a=a||200!==e.status&&201!==e.status,f=c,e.onreadystatechange=null,d(!!a,e))};try{e=new b.XMLHttpRequest}catch(a){try{e=new b.ActiveXObject("Msxml2.XMLHTTP")}catch(a){try{e=new b.ActiveXObject("Microsoft.XMLHTTP")}catch(a){(e={readyState:4,status:-1}).open=e.send=c}}}e.onerror=function(a){e.onerror=null,f(a)};try{e.open("GET",a,!0),e.send(null),e.onreadystatechange=function(){f()}}catch(a){f(a)}}(a,function(a,b){if(a)d(a,null);else try{d(a,JSON.parse(b.responseText))}catch(a){d(a,null)}})}var e="https://stat.radar.imgsmail.ru/update?v=1&p=oauth2";function f(a){(new Image).src=e+"&t=jssdk&i="+a+":1"}var g="__mr_oauth2__";function h(a,b,c){try{var d=window.localStorage,e=g+"."+a,f="ttl_"+g+"."+a;if(1===arguments.length){var h=parseInt(d.getItem(f),10);if(!h||h>Date.now())return JSON.parse(d.getItem(e))}else c>=0&&d.setItem(f,""+(Date.now()+1e3*c)),d.setItem(e,JSON.stringify(b))}catch(a){}return null}function i(a){return document.createElement(a)}function j(a,b){a.appendChild(b)}function k(a){try{a.parentNode.removeChild(a)}catch(a){}}function l(a,b){if(a)for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])}var m=function(a,b){void 0===b&&(b="1.5s");for(var c="_"+Date.now(),d=c+"-spin",e="",f=-146,g=0;f<=92;f+=2)e+='<use fill="rgb('+(g+=2)+","+g+","+g+')" xlink:href="#a" transform="rotate('+f+' 32 32)"/>';return("\n\t<style>\n\t."+c+" {\n\t\twidth: 64px;\n\t\theight: 64px;\n\t\tdisplay: inline-block;\n\t\t-webkit-animation: "+d+" "+b+" linear infinite;\n\t\t-moz-animation: "+d+" "+b+" linear infinite;\n\t\tanimation: "+d+" "+b+" linear infinite;\n\t}\n\t@-moz-keyframes "+d+" { 100% { -moz-transform: rotate(360deg); } }\n\t@-webkit-keyframes "+d+" { 100% { -webkit-transform: rotate(360deg); } }\n\t@keyframes "+d+' { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }\n\t</style>\n\t<div class="'+c+'"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 64 64">\n\t\t<defs>\n\t\t\t<path id="a" d="M0 0h32v32H0z"></path>\n\t\t\t<mask id="progress">\n\t\t\t\t<path d="M0 0h64v64H0z"></path>\n\t\t\t\t'+e+'\n\t\t\t</mask>\n\t\t</defs>\n\t\t<path fill="'+a+'" d="M54.6 47.6c-1.98-1.98-5.09-1.98-7.07 0-8.56 8.56-22.6 8.56-31.1 0-8.56-8.56-8.56-22.6 0-31.1 4.54-5.58-3.25-10.7-7.07-7.07-12.4 12.4-12.4 32.8 0 45.3 12.4 12.4 32.8 12.4 45.3 0 1.98-1.98 1.98-5.09 0-7.07zM32 54c-12.1 0-22-9.9-22-22s9.9-22 22-22c2.8 0 5-2.2 5-5s-2.2-5-5-5C14.4 0 0 14.4 0 32s14.4 32 32 32c7.16-.736 5.26-9.84 0-10z" mask="url(#progress)">\n\t\t</path>\n\t</svg></div>\n').trim()},n="unknown",o="connected",p="not_authorized",q="default",r="onetap",s="hidden",t="embedded",u="ru-RU",v="userinfo",w="mail.phone",x="full-fit",y="mailru-login-button",z="login",A="https://o2.mail.ru",B="2147483647",C="2147483646",D="__mailru_oauth_"+Date.now()+"_"+Math.random()+"__",E=location.protocol+"//"+location.host,F={ui:1,type:1,lang:1,auth:!1},G=/^data-/,H=/^on(load|error|(?:before)?click|login|logout)$/,I=/^https?:/,J=/[?&]lang=([^a-z_-]+)/i,K={},L=[],M=[],N=[],O="o2_mail_ru_popup_login",P=490,Q=500,R=490,S=20,T="close_state",U="login_state",V=1,W=!1,X={clientId:null},Y=window,Z=Y.document,$={btn:"jsapi/button",login:"login",logout:"jsapi/logout",userinfo:"userinfo"},_=[],aa=!1,ba=!1,ca=!1,da=null,ea=null,fa=null,ga=null,ha=n,ia=null,ja=null,ka=[];function la(a,b){return a+":"+b}function ma(a,b,c,d){var e=la(a,b);if(K.hasOwnProperty(e)||(K[e]=[]),d){var f=function(){!function(a,b,c){var d=la(a,b);if(K.hasOwnProperty(d)){var e=K[d].indexOf(c);e>-1&&K[d].splice(e,1)}}(a,b,f),c.apply(null,arguments)};K[e].push(f)}else K[e].push(c)}function na(a,b){var c=$[a]+"?client_id="+X.clientId+"&redirect_uri="+E+(b.lang?"":"&lang="+X.lang);return X.recaptcha,I.test(c)||(c=A+"/"+c),c+"&"+function(a){var b="";for(var c in a)a.hasOwnProperty(c)&&"function"!=typeof c&&null!=a[c]&&(b+="&"+encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.substr(1)}(b)}function oa(a){Ba("call logout"),ha=ha===o?p:n,ia=null,ja=null,ea=null,ka.forEach(function(a){a.send("auth",ha)});var b=sa(!0);ta(a,b),ta(X.onlogin,b),ta(X.onlogout,b),h(U,null)}function pa(){var a,b;Ba("globalOnLogin invoked"),a=sa(),b=a.user,Ba("refresh all prorts",a),ka.forEach(function(c){c.send("auth",a.status),b&&c.send("auth:user",b)}),ta(X.onlogin,sa())}function qa(a,b){function c(a){function c(){pa(),da.close(),ta(M,sa()),ca=!1,ea=null,M.length=0}Ba("login resolved",{ok:a,options:b}),a&&!1!==b.userinfo?ra(c):c()}if(void 0===b&&(b={}),null==b.mode&&(b.mode=q),Ba("call login",{options:b,authUser:!!ia}),ia)ta(a,sa());else{if(a&&M.push(a),ca)return;if(fa){try{fa.close()}catch(a){}fa=null,Y.clearInterval(ga)}da=function(a){var b=V++,c=(g=a,h=g.mode,h===r&&!aa||h===t&&!ba),d=ua(c,b,a),e="popup_"+(c?"embedded_":"")+a.mode+"_";var g,h;if(Ba("openPortal",{id:b,embedded:c,options:a}),c){var n={id:b,loginUrl:d,options:a,radarPrefix:e};return function(a){var b=a.id,c=a.loginUrl,d=a.radarPrefix,e=a.options;Ba("open embedded portal:",b,c,d,e);var g=i("div"),h=i("div"),n=i("iframe"),o=ya(b,n,{embedded:!0,root:g,onClose:function(){k(h)}}),p=Da(),s=R+2*S>=p,u=s?S/2:S,v=s?p-2*u:R,w=Ea()-2*u,x=e.mode===t;n.src=c,n.frameBorder="no",n.width=v+"",n.height="10",n.scrolling="no",l(n,{transform:"translate(0) scale(1,1)"}),l(g,{width:n.width+"px",height:"10px",position:"fixed",opacity:"0",borderRadius:"4px",transform:"translate(0, 20px)",boxShadow:"rgba(0,0,0,.16) 0 4px 20px",zIndex:B,overflow:"hidden",background:"#fff",pointerEvents:"none"}),x?(l(g,{top:"50%",left:"50%"}),l(h,{left:"0",top:"0",right:"0",bottom:"0",position:"fixed",zIndex:C,background:"rgba(0,0,0,.5)",display:"flex",alignItems:"center",justifyContent:"center"}),h.innerHTML='<div style="width: 64px; height: 64px">'+m("#fff")+"</div>"):l(g,{top:u+"px",right:u+"px"});j(g,n),j(Z.body,h),j(Z.body,g),f(d+"try_open"),o.on("connect",function(){f(d+"connected"),da.send("connected",{})});var y=null,z=function(a){var b,c=[],d=!1;function e(a){a(b)}return a(function(a){d||(b=a,d=!0,c.forEach(e),c.length=0)}),{then:function(a){d?e(a):c.push(a)}}}(function(a){o.on("repaint",function(b){var c=b.rect,d=da.el,e=d.parentElement,f=Math.min(c.height,w);c.height>100&&(d.height=f+"",d.width=v+"",d.scrolling=c.height>w?"yes":"no",l(e,{width:v+"px",height:d.height+"px"}),(y=function(a){a&&l(e,{marginTop:"-"+f/2+"px",marginLeft:"-"+v/2+"px"})})(x),a())})});return o.on("ready",function(a){var b=a.hidden;f(d+"ready"),f(d+"ready_hidden_"+b);var c=!1,i=function(a){return z.then(function(){if(!c){var b=x?".6s ease-out":".25s";return y(x),a&&a.position?"center"===a.position?(l(g,{top:"50%",left:"50%"}),y(!0)):(l(g,{top:a.position.top,left:a.position.left}),y(!1)):y(x),n.getBoundingClientRect(),h.textContent="",l(g,{pointerEvents:"",opacity:"1",transform:"translate(0, 0)",transition:"transform "+b+", opacity "+b}),va(e),setTimeout(function(){l(g,{transition:"height .15s ease-out"})},1e3),!0}Aa("Can't show OneTap, because it already closed (it's zombie)")})},j=function(){return z.then(function(){if(!c)return c=!0,o.simulate("cancel"),!0;Aa("OneTap is already closed (it's zombie)")})};if(b)xa(e);else{var k=!1;xa(e,function(){return k=!0,{show:i,close:j}}),!k&&i()}}),o.on("open:login",function(a){var b=a.email;f(d+"open_login"),o.close(),ca=!1,qa(null,{email:b,embedded:!1})}),o.on("unavailable",function(a){var b=a.mode;f(d+"unavailable_"+b),b===r&&(ca=!1,aa=!0,X.mode=q,X.autoLogin=!1),ta(X.onunavailable,{mode:e.mode}),o.close()}),o}(n)}return ea?(Ba("using proxy port",b),f(e+"_create_proxy_port"),va(a),ya(b,{postMessage:function(a){ea.send("login:proxy",a)}},{embedded:c})):(Ba("create popup portal",b),f(e+"_create_popup"),va(a),fa=function a(b){try{return Y.open(d,b,Fa())}catch(c){return"_blank"!==b?a("_blank"):null}}(O),ga=Y.setInterval(function(){try{if(!fa.top||fa.closed)throw"Y"}catch(a){Ca(b,"login:closed",{}),Y.clearInterval(ga)}},100),ya(b,fa,{embedded:!1}))}(b),ca=!0,da.embedded?(da.on("cancel",function(){ca=!1,Ba("embedded portal[login] canceled"),h(T,!0,X.ttlCloseState),f("popup_embedded_"+b.mode+"_canceled"),c(!1),wa(b)}),L.push(function(){Ba("embedded portal[login] resolved"),c(!0)})):(ea||da).on("login:closed",function(){Ba("portal[login] closed"),f("popup_"+b.mode+"_closed_proxy"),c(!0),wa(b)})}}function ra(a){ia?a(ia):(N.push(a),1===N.length&&d(na("userinfo",{access_token:ja}),function(a,b){var c;(c=b)&&c.hasOwnProperty("error")||(ia=b,ha=o),ta(N,ia),N.length=0}))}function sa(a){return{status:ha,user:a?null:ia,access_token:a?null:ja}}function ta(a,b){if(a instanceof Array)a.forEach(function(a){ta(a,b)});else try{a&&a.call(null,b)}catch(a){Aa(a.stack)}}function ua(a,b,c){return na("login",{scope:X.scopes.join(" "),response_type:"token",embedded:a?"Y":null,mode:c.mode,state:JSON.stringify({cid:b,loginState:h(U),ttlLoginState:X.ttlLoginState,skin:X.skin||"default",txtExp:X.txtExp||"default"}),login:c.email})}function va(a){ta(X.onshow,{mode:a.mode})}function wa(a){ta(X.onclose,{mode:a.mode})}function xa(a,b){ta(X.onready,{mode:a.mode,onetap:b?{capture:b}:void 0})}function ya(a,b,c){var d=c.root||b,e={el:b,embedded:c.embedded,root:d,send:function(c,d){var e=JSON.stringify({cid:a,type:c,detail:d});Ba("[port] send: "+c+", detail:",d);try{b.contentWindow.postMessage(e,A)}catch(a){try{b.postMessage(e,A)}catch(a){}}},simulate:function(b,c){void 0===c&&(c={}),Y.postMessage(JSON.stringify({cid:a,type:b,detail:c}),"*")},on:function(b,c,d){return c&&ma(a,b,c,d),this},close:function(){this.send("login:close",{}),k(d),function(a){var b=new RegExp("^"+la(a,""));for(var c in K)b.test(c)&&delete K[c]}(a),ta(c.onClose,[]),d=b=null}};return Ba("[port] created: "+a+", iframe: "+(b instanceof HTMLIFrameElement)),e}function za(a){if(a[D]!==D){a[D]=D,l(a,{position:"relative"});var b=function(a,b){var c=a.attributes.length;for(;c--;){var d=a.attributes[c],e=d.name,f=d.value,g=G.test(e)?e.substr(5):null;g&&(H.test(g)?(!Y[f]&&Aa("Callback '"+e+'="'+f+"\"' not found"),b[g]=Y[f]):F[g]&&(b[g]=f))}return b}(a,{cid:V++,type:z,ui:""}),c=i("iframe"),d=ya(b.cid,c,{embedded:!1});c.width="100%",c.height="100%",l(c,{display:"inline-block",verticalAlign:"middle",borderRadius:"2px",transition:"all .1s ease-out"});var e=function(){return d.send("login:cfg",{url:ua(!1,b.cid,{mode:q,modern:!0}),name:O,embedded:X.mode===t,width:P,height:Q,params:Fa()})};a.addEventListener("focusin",function(){e()}),a.addEventListener("mouseover",function(){e()}),a.addEventListener("touchstart",function(){e()}),d.on("load",function(a){Ba("port[button] loaded",b.cid),e(),ka.push(d),b.ui.indexOf(x)>-1&&d.on("resize",function(a){var b=a.width,d=a.height;c.width=b,c.height=d}),d.on("beforeclick",function(a){ka.forEach(function(a){a!==d&&a.send("login:close",{})}),ta(b.onbeforeclick,a)}),d.on("open:embedded",function(){Ba("port[button] invoke embedded login",b.cid),qa(null,{mode:t})}),d.on("click",function(a){ia?(f("button_logout_click"),oa(b.onlogout)):(f("button_login_click"),ea=d,qa(b.onlogin)),ta(b.onclick,a)}),f("button_onload_"+a.status),ta(b.onload,a)},!0),c.onerror=function(){Aa("[transport] Internal error"),f("transport_error"),ta(b.onerror,sa(!0))},c.setAttribute("frameborder","0"),c.scrolling="no",j(a,c),c.src=na("btn",b),Ba("port[button] created",b)}}function Aa(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];_.push("warn",a)}function Ba(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];_.push("info",a)}function Ca(a,b,c){var d=la(a,b);K.hasOwnProperty(d)&&ta(K[d],c)}function Da(){return Y.innerWidth||Z.documentElement.clientWidth}function Ea(){return Y.innerHeight||Z.documentElement.clientHeight}function Fa(){var a=Y.screen,b=null!=Y.screenLeft?Y.screenLeft:a.left,c=null!=Y.screenTop?Y.screenTop:a.top,d=Da()||a.width,e=Ea()||a.height;return["scrollbars=no","left="+((d-P)/2+(parseInt(b,10)||0)),"top="+((e-Q)/2.3+(parseInt(c,10)||0)),"width="+P,"height="+Q].join(",")}function Ga(a){var b,c=a.origin,d=a.data;if(""!==d&&c===A)try{Ba("message",d);var e=JSON.parse(d),g=e.cid,i=e.type,j=e.detail;switch(Ca(g,i,j),i){case"load":ha=j.status,f("message_load_auth_status_"+j.status);break;case"auth":f("message_auth_status_"+j.status),b=j.access_token,ja=b||null,L.splice(0,1e6).forEach(function(a){a({status:ja?o:p,access_token:ja})}),ja&&X.ttlLoginState&&h(U,!0,X.ttlLoginState)}}catch(a){Aa(a.stack||a.message)}}setInterval(function(){ka=ka.filter(function(a){if("IFRAME"===a.el.nodeName){for(var b=a.el;b=b.parentNode;)if(b===Z.body)return!0;return Ba("[gc] port removed:",a),!1}return!0})},3e4),a.AUTH_UNKNOWN=n,a.AUTH_CONNECTED=o,a.AUTH_NOT_AUTHORIZED=p,a.MODE_DEFAULT=q,a.MODE_XHR="xhr",a.MODE_ONETAP=r,a.MODE_HIDDEN=s,a.MODE_EMBEDDED=t,a.LANG_RU=u,a.LANG_EN="en-US",a.SCOPE_USER_INFO=v,a.SCOPE_MAIL_PHONE=w,a.SCOPE_MAIL_IMAP="mail.imap",a.SCOPE_CLOUD_API="cloud.api",a.UI_FULL_FIT=x,a.UI_LOGIN_AS="login_as",a.UI_USERPIC="userpic",a.UI_ALWAYS_LOGIN="always_login",a.BUTTON_CLASSNAME=y,a.BUTTON_TYPE_LOGIN=z,a.OAUTH_HOST=A,a.__DEV__=function(a){},a.reset=function(){h(T,null),h(U,null)},a.init=function(a){if(W)Ba("reinit",a);else{if(Ba("init",a),!a)throw new Error("[MR.init] `options` not defined");if(W=!0,X=a,!a.clientId)throw new Error("[MR.init] `options.clientId` not defined");null==a.lang&&(a.lang=(Y.location.toString().match(J)||[])[1]||Y.navigator.language||Y.navigator.languages&&Y.navigator.languages[0]||u),Ba("[button] lang: "+a.lang+" (nav: "+Y.navigator.language+", ["+Y.navigator.languages+"]"),null==a.scopes&&(a.scopes=[v]),null==a.modern&&(a.modern=a.scopes.indexOf(w)>-1||location.toString().indexOf("o2.modern")>-1),null==a.mode&&(a.mode=q),null==a.ttlCloseState&&(a.ttlCloseState=2592e3),null==a.ttlLoginState&&(a.ttlLoginState=a.mode===r?604800:0),a.mode===r&&(!h(T)||a.ttlCloseState<=0)&&(Ba("onetap autologin"),qa(null,{mode:r})),Y.addEventListener("message",Ga,!1)}!function(a){for(var b=Z.getElementsByClassName(y),c=b.length;c--;)a(b[c])}(za)},a.logout=oa,a.auth=function(a){var b=V++,c=i("iframe");Ba("call auth"),l(c,{visibility:"hidden",position:"absolute",left:"-999px",top:"-999px"}),t===X.mode?L.push(function(b){var d=-1!==X.scopes.indexOf(v);k(c),b.status===o?d?ra(function(){Ba("auth successfully with userinfo",sa()),ta(a,sa()),pa()}):(Ba("auth successfully",b),ta(a,b),pa()):(Aa("User not authorized:",b),qa(a,{userinfo:d,mode:t}))}):L.push(a),c.src=na("login",{scope:X.scopes.join(" "),response_type:"token",mode:s,state:"cid="+b+"&e="+D}),j(Z.body,c)},a.login=qa,a.getUser=ra,a.getState=function(){return sa()},a.getRuntimeLog=function(){return _},Object.defineProperty(a,"__esModule",{value:!0})});